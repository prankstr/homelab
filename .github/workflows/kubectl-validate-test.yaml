name: kubectl-validate
on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  changed-apps:
    name: Get changed apps
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo content
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get all apps that changed
        id: changed-apps
        uses: tj-actions/changed-files@v44

      - name: List all changed files
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          for file in ${ALL_CHANGED_FILES}; do
            echo "$file was changed"
          done

  k8s-manifests-validation:
    runs-on: homelab-arc-runner-set
    needs: changed-apps
    strategy:
      matrix:
        app: ${{ fromJSON(needs.changed-apps.outputs.matrix) }}
    steps:
      - name: Checkout repo content
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup go
        uses: actions/setup-go@v5

      - name: Install kubectl-validate
        run: go install sigs.k8s.io/kubectl-validate@latest

      - name: Install Kustomize
        run: |
          sudo apt-get update
          sudo apt-get install -y kustomize

      - name: Kustomize Build
        run: kustomize build --enable-helm ${{ matrix.app }} > ${{ matrix.app }}/bundle.yaml

      - name: Run kubectl-validate
        run: kubectl-validate ${{ matrix.app }}/bundle.yaml
