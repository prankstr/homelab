apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: k10

resources:
  - oidc-secret.yaml
  - vmpodscrape.yaml
  - vmscrapeconfig.yaml

patches:
  - target:
      group: rbac.authorization.k8s.io
      kind: ClusterRoleBinding
      name: backup-k10-k10-cluster-admin
      version: v1
    patch: |
      - op: add
        path: /subjects/-
        value:
          apiGroup: rbac.authorization.k8s.io
          kind: User
          name: https://auth.{ MY_DOMAIN }/application/o/k10/#david
  - target:
      group: ""
      version: v1
      kind: Service
      name: gateway
      namespace: k10
    patch: |
      - op: replace
        path: /metadata/name
        value: gateway-svc
  - target:
      group: networking.k8s.io
      version: v1
      kind: Ingress
      name: k10-ingress
      namespace: k10
    patch: |
      - op: replace
        path: /spec/rules/0/http/paths/0/backend/service/name
        value: gateway-svc

generatorOptions:
  disableNameSuffixHash: true
  labels:
    grafana_dashboard: "1"

configMapGenerator:
  - files:
      - k10-dashboard.json
    name: k10-dashboard

# Need to set namespace here as well, otherwise some resources are created in the wrong namespace
helmCharts:
  - includeCRDs: true
    name: k10
    namespace: k10
    releaseName: k10
    repo: https://charts.kasten.io
    valuesFile: values.yaml
    version: 7.5.2
